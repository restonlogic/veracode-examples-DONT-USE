name: backend-pipeline
# Run workflow only when committing to frontend directory
on:
  push:
    branches:
      - main
    #paths:
    #  - "aws/k3s-terraform-cluster/microservices/**"

permissions:
  id-token: write
  contents: read

jobs:
  build:
    # The image this workflow works on
    runs-on: ubuntu-latest
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout Github Repository
        uses: actions/checkout@v4

      - name: Export Variables
        run: |
          cd aws/k3s-terraform-cluster
          echo "ACTION=$(jq '.github_actions.action' -r manifest.json)" >> $GITHUB_ENV
          echo "NAME=$(jq '.global_config.name' -r manifest.json)" >> $GITHUB_ENV
          echo "ENV=$(jq '.global_config.environment' -r manifest.json)" >> $GITHUB_ENV
          echo "ORG=$(jq '.global_config.organization' -r manifest.json)" >> $GITHUB_ENV
          echo "AWS_REGION=$(jq '.global_config.region' -r manifest.json)" >> $GITHUB_ENV

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: "arn:aws:iam::972962050678:role/github-actions"
          aws-region: us-east-1

      - name: Export Variables
        run: |
          echo "image=counter-service"
          echo "build_tag=$(git rev-parse --short HEAD)"
          echo "ecr_password=$(aws ecr get-login-password --region $AWS_REGION)"
          echo "ext_lb_dns=$(aws elbv2 describe-load-balancers --names k3s-ext-lb-$env --region $AWS_REGION | jq -r '.LoadBalancers[].DNSName')"

      - name: Get Veracode Secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            /veracode/mgmt/veracode-secrets
          parse-json-secrets: true

      - name: Get ECR Repo URL
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            /veracode/mgmt/ecr-repo/counter-service

      - name: Get Kubeconfig
        run: |
          k3s_kubeconfig=/tmp/k3s_kubeconfig
          aws secretsmanager get-secret-value --secret-id k3s-kubeconfig-${NAME}-${ENV}-${ORG}-${ENV}-v2 --region $AWS_REGION | jq -r '.SecretString' > $k3s_kubeconfig
          export KUBECONFIG=$k3s_kubeconfig

      - name: ZIP source folder
        run: |
          pwd
          cd ../microservices/$image"
          zip -r app.zip app

      - name: Run Veracode Static Code Analysis
        uses: veracode/veracode-uploadandscan-action@0.2.6
        with:
          appname: $image
          version: "${image}-build-${build_tag}"
          createprofile: true
          filepath: "app.zip"
          scantimeout: 30
          criticality: medium
          debug: true
          vid: $_VERACODE_MGMT_VERACODE_SECRETS_VERACODE_API_ID
          vkey: $_VERACODE_MGMT_VERACODE_SECRETS_VERACODE_API_KEY
